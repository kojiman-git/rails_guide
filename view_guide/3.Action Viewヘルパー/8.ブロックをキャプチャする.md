# ブロックをキャプチャする（8章）要約（拡張版）

## 概要
**8章**では、Railsにおけるビューやレイアウトの中で、生成されたマークアップ（HTML）を一時的に保持し、他の場所で再利用するための2つの便利なヘルパーメソッドについて学びます。

- `capture`（**8.1**）：マークアップの出力を変数に保存し、任意の場所で再利用できるようにします。
- `content_for`（**8.2**）：特定の識別子と共にブロックを保存し、レイアウトファイルなどで `yield` を使って呼び出す仕組みです。

これらのメソッドは、ページタイトルの動的な設定、再利用可能なHTML構造の抽出、セクションごとのカスタマイズに役立ちます。特にレイアウトを共通化しつつページ固有の要素を挿入したいときに活躍します。

---

## 8.1 `capture`
- **用途**：ビュー内で生成されるHTMLブロックを変数に格納し、他の場所で再利用できるようにします。
- **仕組み**：`capture`メソッドは、ブロックで評価された内容（HTML）を文字列として返します。この文字列を変数に代入することで、後続の任意の場所で出力可能になります。

- **使用例**：
  ```erb
  <% @greeting = capture do %>
    <p>Welcome to my shiny new web page! The date and time is <%= Time.current %></p>
  <% end %>
  ```

- **利用場面**：
  ```erb
  <body>
    <%= @greeting %>
  </body>
  ```

- **出力例**：
  ```html
  <p>Welcome to my shiny new web page! The date and time is 2018-09-06 11:09:16 -0500</p>
  ```

- **補足**：
  - `capture`は状態を持たないため、複数回呼び出してもその都度独立した内容を返します。
  - 主にビュー内やヘルパー内で使われ、パーシャルなどのHTML断片を動的に扱う際に有効です。

---

## 8.2 `content_for`
- **用途**：マークアップのブロックを**識別子（シンボル）付きで保存**し、`yield(:識別子)`でその内容を再利用します。

- **基本構文と使用例**：
  ```erb
  <% content_for(:html_title) { "Special Page Title" } %>
  ```
  上記で`:html_title`という識別子に文字列が保存されます。

- **レイアウト側での呼び出し**：
  ```erb
  <title><%= content_for?(:html_title) ? yield(:html_title) : "Default Title" %></title>
  ```
  `content_for?`は、対象識別子にコンテンツが登録済みかを確認する述語メソッドです。

- **ヘルパーモジュールとの併用**：
  ```ruby
  module TitleHelper
    def html_title
      content_for(:html_title) || "Default Title"
    end
  end
  ```
  レイアウトファイルでは `<title><%= html_title %></title>` のように呼び出せます。

- **複数回呼び出しの挙動**：
  - `content_for`は、同じ識別子に対して複数回呼び出された場合、**すべてのブロックを順番に連結**します。
  - これにより、スクリプトやスタイルシートの定義など、ページの一部を段階的に積み上げたい場合に非常に有効です。

- **注意点**：
  - `content_for`で保存されたブロックは、**フラグメントキャッシュ**対象の中では無視されるため、キャッシュ内で利用するのは避けましょう。

---

## capture と content_for の違い
| 比較項目       | `capture`                           | `content_for`                                      |
|----------------|--------------------------------------|----------------------------------------------------|
| 保存先         | ローカル変数やインスタンス変数     | シンボル（識別子）                                |
| 再利用方法     | 変数を直接呼び出す                 | `yield(:識別子)` またはヘルパー経由で出力         |
| 複数回呼び出し | 都度独立した内容が返る             | 既存の内容に**追加で連結**される                  |
| キャッシュ対応 | 使用可能                            | **キャッシュ中では無視される**                     |
| 内部構造       | シンプルなブロック評価              | **内部でcaptureを利用して実装されている**         |

---

## まとめ
`capture`と`content_for`は、Railsのビューやレイアウトを柔軟かつ再利用性の高い構造にするために欠かせない2つの重要なツールです。

- `capture` は、**一時的なHTML断片を変数に保存**して後から使用したいときに適しています。
- `content_for` は、**レイアウトとテンプレートの連携**を効率よく行うために設計されたしくみで、特定の識別子を通じてページごとに変わる情報（タイトルやスクリプトなど）を動的に差し込めます。

どちらも**テンプレート設計の柔軟性と拡張性を高める強力な仕組み**です。使い分けを理解し、適材適所で活用することで、保守性と再利用性の高いRailsアプリケーションを実現できます。


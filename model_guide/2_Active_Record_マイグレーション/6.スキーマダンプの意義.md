# **スキーマダンプの意義**

## **6.1 スキーマファイルの意味について**
Railsのマイグレーションは強力ですが、**データベーススキーマを作成するための唯一の信頼できる情報源ではありません**。最終的な情報源は、常に現在稼働しているデータベースの状態です。

Railsはデフォルトで、**データベーススキーマの最新状態をキャプチャ** する `db/schema.rb` を生成します。

### **スキーマダンプとは？**
スキーマダンプとは、**データベースの現在の構造（テーブル、カラム、インデックスなど）をファイルに出力すること** です。Railsでは、マイグレーションをすべて適用する代わりに、スキーマダンプを利用してデータベースを再現することができます。

### **スキーマファイルの活用方法**
✅ **新しいデータベースインスタンスの作成**
- マイグレーションの全履歴を繰り返すよりも、`rails db:schema:load` を使う方が速く、エラーが発生しにくい。

✅ **マイグレーションの外部依存性が変更された場合の対応**
- 古いマイグレーションが正しく適用できなくなる可能性がある。

✅ **Active Recordのオブジェクト情報の確認**
- モデルのコードにはスキーマ情報が含まれていないが、スキーマファイルを見れば現在のデータ構造を手軽にチェックできる。

---

## **6.2 スキーマダンプの種類**
Railsでは、`config/application.rb` の `config.active_record.schema_format` 設定によって、スキーマダンプのフォーマットを指定できます。

### **6.2.1 デフォルトの `:ruby` スキーマ**
`:ruby` を選択すると、スキーマは `db/schema.rb` に保存され、**1つの巨大なマイグレーションのような形式** になります。

#### **スキーマファイルの例**
```ruby
ActiveRecord::Schema[8.0].define(version: 2024_09_06_171750) do
  create_table "authors", force: true do |t|
    t.string   "name"
    t.datetime "created_at"
    t.datetime "updated_at"
  end

  create_table "products", force: true do |t|
    t.string   "name"
    t.text     "description"
    t.datetime "created_at"
    t.datetime "updated_at"
    t.string   "part_number"
  end
end
```
このスキーマ情報は、データベースの構造を `create_table` や `add_index` などの形で表現しています。

---

### **6.2.2 `:sql` スキーマダンプ**
`:ruby` スキーマでは、**トリガー、シーケンス、ストアドプロシージャ、チェック制約** などのデータベース固有の項目を表現できません。

これらを含める必要がある場合、スキーマのフォーマットを `:sql` に指定すると、**データベース固有の構造も含めたスキーマダンプ** を生成できます。

#### **SQLスキーマの作成方法**
```sh
$ bin/rails db:structure:dump
```

データベース固有のツールを用いて `db/structure.sql` にダンプします。
- **PostgreSQL** → `pg_dump`
- **MySQL/MariaDB** → `SHOW CREATE TABLE` の出力をファイルに含める

スキーマを `db/structure.sql` から復元するには、以下のコマンドを実行します。
```sh
$ bin/rails db:schema:load
```
これにより、SQL文が実行され、元のデータベース構造が再現されます。

---

## **6.3 スキーマダンプとソースコード管理**
**スキーマファイルはGitなどのソースコード管理に追加することを推奨** します。

✅ **マージ時のコンフリクト管理**
- 複数のブランチでスキーマを変更すると、マージ時に `schema.rb` がコンフリクトする可能性があります。
- **解決策:**
  ```sh
  $ bin/rails db:migrate
  ```
  これにより、スキーマファイルを最新の状態に再生成できます。

✅ **新規Railsアプリの設定**
- `migrations/` フォルダは `git` に含まれているため、常に新しいマイグレーションを `git add` してコミットする。

---

# **既存のマイグレーションを変更する**

## **5. 既存のマイグレーションを変更する**

マイグレーションを作成していると、誤って実行してしまうことがあります。しかし、すでに適用されたマイグレーションをそのまま編集して `rails db:migrate` を実行しても、Rails はそのマイグレーションが適用済みと認識しているため、変更が反映されません。

このような場合、以下の手順で修正を適用します。

1. **マイグレーションをロールバック**
   ```sh
   $ bin/rails db:rollback
   ```
2. **マイグレーションファイルを修正**
3. **再度マイグレーションを実行**
   ```sh
   $ bin/rails db:migrate
   ```

---

## **既存のマイグレーションの編集の注意点**

### **❌ 直接編集してはいけない場合**
バージョン管理システム（Gitなど）に **コミット済み** で、 **本番環境（production）で適用されている** マイグレーションを直接書き換えるのは避けるべきです。これを行うと、他の開発者に影響を与え、余分な作業が発生する可能性があります。

**✅ 正しい方法:**
- **新しいマイグレーションを作成し、必要な変更を適用する**
- `rails generate migration` コマンドを使い、修正のためのマイグレーションを作成

```sh
$ bin/rails generate migration AddNewColumnToUsers new_column:string
```

これにより、既存のマイグレーションを改変せずに変更を適用できます。

---

## **コミット前のマイグレーション修正**
まだバージョン管理システムに **コミットしていない** 場合は、マイグレーションファイルを直接編集しても問題ありません。例えば、ローカル環境のみで適用されたマイグレーションであれば、`db:rollback` で取り消した後に修正できます。

---

## **`revert` メソッドを活用する**
`revert` メソッドは、以前のマイグレーション全体または一部を逆進させる新しいマイグレーションを作成する際に便利です。

```ruby
class RevertExampleMigration < ActiveRecord::Migration[8.0]
  def change
    revert do
      create_table :example_table do |t|
        t.string :name
      end
    end
  end
end
```

これにより、過去のマイグレーションの影響を安全に取り消しつつ、新しい変更を適用できます。

---